@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using MusicSmash.Components.Sub_Components
@using MusicSmash.Controllers.Api.Spotify
@using MusicSmash.Models
@inject NavigationManager navigationManager
@inject IHttpContextAccessor httpContext
@inject Api spotifyAPI

@if (isAuthenticated)
{
    <script>window.location.replace("/vote")</script>
}
else
{
    <script>window.location.replace("/login")</script>
}

<PageTitle>MusicMatch</PageTitle>

@code
{
    protected async Task<bool> ControlRender()
    {
        string token = string.Empty;
        if (!httpContext?.HttpContext?.Request.Cookies.TryGetValue("token", out token) ?? false)
            return false;

        var result = await spotifyAPI.GetUserProfileAsync(token).ConfigureAwait(false);
        var isPremium = result.Product == "premium";

        return true;
    }

    public bool isAuthenticated => ControlRender().Result;
}